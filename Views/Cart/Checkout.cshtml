@model Project.ViewModels.CartViewModel
@{
    ViewData["Title"] = "Secure Checkout";
}

<div class="pt-32 pb-20 px-6 max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
        
        <div class="animate-fade-in">
            <h1 class="text-4xl font-bold mb-8">Secure Checkout</h1>
            
            <form asp-action="ProcessCheckout" method="post" class="space-y-8">
                
                <div class="glass p-8">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-3">
                        <i class="bi bi-truck text-primary"></i> Shipping Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="text-xs text-slate-500 uppercase mb-2">Full Name</label>
                            <input asp-for="FullName" class="w-full bg-[#1a1c2e] border border-[var(--glass-border)] rounded-xl px-4 py-3 focus:border-primary outline-none transition-colors" placeholder="John Doe" />
                            <span asp-validation-for="FullName" class="text-red-500 text-xs mt-1 block"></span>
                        </div>
                        <div class="md:col-span-2">
                            <label class="text-xs text-slate-500 uppercase mb-2">Street Address</label>
                            <input asp-for="Address" class="w-full bg-[#1a1c2e] border border-[var(--glass-border)] rounded-xl px-4 py-3 focus:border-primary outline-none transition-colors" placeholder="123 Gallery Way" />
                            <span asp-validation-for="Address" class="text-red-500 text-xs mt-1 block"></span>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 uppercase mb-2">City</label>
                            <input asp-for="City" class="w-full bg-[#1a1c2e] border border-[var(--glass-border)] rounded-xl px-4 py-3 focus:border-primary outline-none transition-colors" placeholder="New York" />
                            <span asp-validation-for="City" class="text-red-500 text-xs mt-1 block"></span>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 uppercase mb-2">ZIP Code</label>
                            <input asp-for="ZipCode" class="w-full bg-[#1a1c2e] border border-[var(--glass-border)] rounded-xl px-4 py-3 focus:border-primary outline-none transition-colors" placeholder="10001" />
                            <span asp-validation-for="ZipCode" class="text-red-500 text-xs mt-1 block"></span>
                        </div>
                    </div>
                </div>

                
                <div class="glass p-8 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-primary/5 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                    
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-3">
                        <i class="bi bi-credit-card text-primary"></i> Payment Method
                    </h3>
                    
                    <div class="space-y-6">
                        <div class="relative">
                            <label class="text-xs text-slate-500 uppercase mb-2">Card Number</label>
                            <div class="relative">
                                <input asp-for="CardNumber" id="cardNumber" maxlength="19" class="w-full bg-[#1a1c2e] border border-[var(--glass-border)] rounded-xl px-4 py-3 pr-16 focus:border-primary outline-none transition-colors tracking-widest font-mono" placeholder="0000 0000 0000 0000" />
                                <div id="cardIcon" class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl transition-all duration-300 opacity-50">
                                    <i class="bi bi-credit-card"></i>
                                </div>
                            </div>
                            <span asp-validation-for="CardNumber" class="text-red-500 text-xs mt-1 block"></span>
                            <p id="cardTypeDisplay" class="text-[10px] uppercase tracking-widest mt-2 text-primary font-bold hidden">Detecting...</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="text-xs text-slate-500 uppercase mb-2">Expiry Date</label>
                                <input asp-for="ExpirationDate"
       type="month"
       min="@DateTime.Now.ToString("yyyy-MM")"
       class="w-full bg-[#1a1c2e] border border-[var(--glass-border)] rounded-xl px-4 py-3 focus:border-primary outline-none transition-colors" />
                                <span asp-validation-for="ExpirationDate" class="text-red-500 text-xs mt-1 block"></span>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 uppercase mb-2">CVV</label>
                                <input asp-for="CVV" type="password" maxlength="4" class="w-full bg-[#1a1c2e] border border-[var(--glass-border)] rounded-xl px-4 py-3 focus:border-primary outline-none transition-colors" placeholder="***" />
                                <span asp-validation-for="CVV" class="text-red-500 text-xs mt-1 block"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-premium w-full py-4 text-lg flex items-center justify-center gap-3">
                    <i class="bi bi-lock-fill"></i> Complete Purchase â€¢ $@Model.Total
                </button>
                <p class="text-center text-slate-500 text-xs mt-4">
                    <i class="bi bi-shield-check"></i> Your payment information is encrypted and secure.
                </p>
            </form>
        </div>

        
        <div class="animate-fade-in" style="animation-delay: 0.2s;">
            <div class="sticky top-32">
                <div class="glass p-8">
                    <h3 class="text-xl font-bold mb-8">Order Summary</h3>
                    
                    <div class="max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                        <div class="space-y-6">
                            @foreach (var item in Model.CartItems)
                            {
                                <div class="flex items-center gap-4">
                                    <div class="w-20 h-20 rounded-xl overflow-hidden border border-[var(--glass-border)] flex-shrink-0">
                                        @if(!string.IsNullOrEmpty(item.ImageUrl)) {
                                            <img src="@item.ImageUrl" class="w-full h-full object-cover" />
                                        } else {
                                            <div class="w-full h-full bg-slate-800 flex items-center justify-center">
                                                <i class="bi bi-image"></i>
                                            </div>
                                        }
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-bold truncate">@item.Name</h4>
                                        <p class="text-slate-500 text-sm">Qty: @item.Quantity</p>
                                    </div>
                                    <div class="font-mono text-primary font-bold">
                                        $@item.Total
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="mt-8 pt-8 border-t border-[var(--glass-border)] space-y-4">
                        <div class="flex justify-between text-slate-400">
                            <span>Subtotal</span>
                            <span>$@Model.Total</span>
                        </div>
                        <div class="flex justify-between text-slate-400">
                            <span>Shipping</span>
                            <span class="text-green-500">Free</span>
                        </div>
                        <div class="flex justify-between text-xl font-bold text-white pt-4">
                            <span>Grand Total</span>
                            <span class="text-primary">$@Model.Total</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script>
        const cardInput = document.getElementById('cardNumber');
        const cardIcon = document.getElementById('cardIcon');
        const cardTypeDisplay = document.getElementById('cardTypeDisplay');

        cardInput.addEventListener('input', function(e) {

            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = '';
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) formattedValue += ' ';
                formattedValue += value[i];
            }
            e.target.value = formattedValue;


            const firstFour = value.substring(0, 4);
            if (value.length >= 1) {
                cardTypeDisplay.classList.remove('hidden');
                if (value.startsWith('4')) {
                    cardIcon.innerHTML = '<i class="bi bi-credit-card-2-front text-[#1A1F71]"></i>';
                    cardTypeDisplay.innerText = 'Visa Verified';
                    cardTypeDisplay.className = 'text-[10px] uppercase tracking-widest mt-2 text-blue-400 font-bold';
                    cardIcon.style.opacity = '1';
                } else if (/^(51|52|53|54|55)/.test(value) || (firstFour >= "2221" && firstFour <= "2720")) {
                    cardIcon.innerHTML = '<i class="bi bi-credit-card-2-front text-[#EB001B]"></i>';
                    cardTypeDisplay.innerText = 'Mastercard Verified';
                    cardTypeDisplay.className = 'text-[10px] uppercase tracking-widest mt-2 text-red-500 font-bold';
                    cardIcon.style.opacity = '1';
                } else {
                    cardIcon.innerHTML = '<i class="bi bi-credit-card"></i>';
                    cardTypeDisplay.innerText = 'Unsupported Card';
                    cardTypeDisplay.className = 'text-[10px] uppercase tracking-widest mt-2 text-slate-500 font-bold';
                    cardIcon.style.opacity = '0.5';
                }
            } else {
                cardTypeDisplay.classList.add('hidden');
                cardIcon.innerHTML = '<i class="bi bi-credit-card"></i>';
                cardIcon.style.opacity = '0.5';
            }
        });
    </script>
}
